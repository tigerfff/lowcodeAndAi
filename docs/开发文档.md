# 智能页面代码生成工具 - 开发文档

## 一、技术架构

### 1.1 整体架构

```
┌─────────────────────────────────────────────────┐
│                  用户界面层                      │
│  - 模板选择器                                    │
│  - 组件选择器                                    │
│  - API 配置界面                                  │
│  - 代码预览器                                    │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│                  业务逻辑层                      │
│  - 模板管理器（templateManager.js）             │
│  - 组件库管理器（componentLibrary.js）          │
│  - 配置管理器（configManager.js）               │
│  - 代码生成器（codeGenerator.js）               │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│                  数据层                          │
│  - 模板定义（template.json）                    │
│  - 模板文件（page.vue.hbs）                     │
│  - 组件库定义（componentLibrary.js）            │
│  - JSON Schema（配置校验）                      │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│                  AI 层                           │
│  - 配置推断                                      │
│  - 代码生成                                      │
└─────────────────────────────────────────────────┘
```

### 1.2 核心流程

```
用户选择模板
  ↓
用户选择组件
  ↓
用户填写 API
  ↓
AI 推断配置
  ↓
Handlebars 模板渲染
  ↓
AI 生成业务逻辑
  ↓
输出 Vue 代码
```

---

## 二、目录结构

```
ai-code/
├── src/
│   ├── components/          # UI 组件
│   │   ├── CodePreviewDialog.vue      # 代码预览对话框
│   │   └── README.md
│   ├── services/            # 核心服务
│   │   ├── templateManager.js         # 模板管理器
│   │   ├── componentLibrary.js        # 组件库管理器
│   │   ├── configManager.js           # 配置管理器
│   │   ├── codeGenerator.js           # 代码生成器
│   │   └── README.md
│   ├── stores/              # 状态管理
│   │   ├── editorStore.js             # 编辑器状态
│   │   └── README.md
│   ├── views/               # 页面
│   │   ├── Editor.vue                 # 主编辑器页面
│   │   └── README.md
│   └── main.js              # 入口文件
├── templates/               # 模板库
│   ├── standard-list/       # 标准列表页模板
│   │   ├── template.json              # 模板定义
│   │   ├── page.vue.hbs               # Handlebars 模板
│   │   └── README.md                  # 模板说明
│   └── README.md
├── manifests/               # 配置清单
│   ├── page-config.schema.json        # 页面配置 Schema
│   └── README.md
├── config/                  # 配置文件
│   ├── ai.example.json                # AI 配置示例
│   └── README.md
├── docs/                    # 文档
│   ├── 产品文档.md
│   └── 开发文档.md
└── package.json
```

---

## 三、核心模块

### 3.1 模板管理器（templateManager.js）

**功能**：
- 加载和管理模板
- 获取模板定义
- 验证模板配置

**核心方法**：
```javascript
// 获取所有模板
getAllTemplates()

// 根据 ID 获取模板
getTemplateById(templateId)

// 验证模板配置
validateTemplate(template)
```

---

### 3.2 组件库管理器（componentLibrary.js）

**功能**：
- 管理组件定义
- 提供组件元数据
- 组件搜索和过滤

**核心方法**：
```javascript
// 获取所有组件
getAllComponents()

// 根据名称获取组件
getComponentByName(componentName)

// 搜索组件
searchComponents(keyword)

// 验证组件配置
validateComponentConfig(componentConfig)

// 获取组件默认配置
getDefaultConfig(componentName)
```

**组件定义格式**：
```javascript
{
  name: 'el-input',
  label: '输入框',
  category: 'search',
  wrapper: 'h-page-search-item',
  defaultProps: {
    placeholder: '请输入',
    clearable: true
  },
  props: [
    {
      name: 'placeholder',
      label: '占位符',
      type: 'string',
      default: '请输入'
    }
  ],
  events: ['input', 'change', 'blur'],
  suitableFor: ['searchArea', 'formArea']
}
```

---

### 3.3 配置管理器（configManager.js）

**功能**：
- 配置导入导出
- 配置校验
- 配置转换

**核心方法**：
```javascript
// 导出配置
exportConfig(config, format)

// 导入配置
importConfig(data)

// 校验配置
validateConfig(config, schema)

// 配置格式转换
convertConfig(config, fromFormat, toFormat)
```

---

### 3.4 代码生成器（codeGenerator.js）

**功能**：
- 构建 AI Prompt
- 调用 AI 生成代码
- 使用模板生成代码
- 代码格式化和校验

**核心方法**：
```javascript
// 生成代码（主入口）
generateCode(config, options)

// 构建 AI Prompt
buildAIPrompt(config)

// 使用 AI 生成代码
generateWithAI(prompt, config)

// 使用模板生成代码
generateWithTemplate(config)
```

**代码生成流程**：
```
1. 构建 AI Prompt（包含模板、组件、API 信息）
2. 调用 AI 推断配置（字段、属性、依赖关系）
3. Handlebars 模板渲染（生成页面结构）
4. AI 生成业务逻辑（API 调用、数据流转、事件处理）
5. 合并代码（template + script + style）
6. 格式化和校验
7. 返回最终代码
```

---

## 四、数据结构

### 4.1 模板定义（template.json）

```json
{
  "id": "standard-list",
  "label": "标准列表页",
  "description": "带搜索的表格列表",
  "version": "1.0.0",
  "layout": {
    "structure": "fixed",
    "template": "page.vue.hbs"
  },
  "slots": {
    "searchArea": {
      "label": "搜索区",
      "maxCount": 6,
      "allowedComponents": ["el-input", "el-select", "el-date-picker"]
    }
  },
  "aiTasks": [
    "从 API 响应推断表格列配置",
    "从 API 请求参数推断搜索字段配置"
  ],
  "configSchema": {
    "type": "object",
    "required": ["pageName", "api"],
    "properties": {
      "pageName": { "type": "string" },
      "api": { "type": "object" }
    }
  }
}
```

### 4.2 页面配置（pageConfig）

```json
{
  "templateId": "standard-list",
  "pageName": "UserList",
  "breadcrumb": ["首页", "用户管理"],
  "api": {
    "url": "/api/users/list",
    "method": "POST"
  },
  "slots": {
    "searchArea": [
      {
        "component": "el-input",
        "order": 1
      },
      {
        "component": "el-select",
        "order": 2
      }
    ]
  }
}
```

### 4.3 AI 推断结果

```json
{
  "searchArea": [
    {
      "component": "el-input",
      "props": {
        "prop": "userName",
        "label": "用户名",
        "placeholder": "请输入用户名"
      },
      "confidence": 0.95
    }
  ],
  "apiConfig": {
    "dataPath": "data.rows",
    "totalPath": "data.total",
    "confidence": 0.90
  },
  "dependencies": [
    {
      "from": "区域选择器",
      "to": "团队选择器",
      "trigger": "change",
      "confidence": 0.85
    }
  ]
}
```

---

## 五、AI 集成

### 5.1 AI Prompt 构建

**Prompt 结构**：

```markdown
# 页面配置推断任务

## 用户输入
- 模板：standard-list
- 组件：区域选择器、团队选择器、数据表格
- API：/api/problems/list, /api/areas, /api/teams

## 模板约束
[template.json 的 slots 定义]

## 组件库
[componentLibrary.js 的组件定义]

## 推断任务
1. 推断每个组件的属性（字段名、标签、配置）
2. 推断 API 配置（请求参数、响应格式、数据映射）
3. 推断组件依赖关系（谁触发谁、数据如何传递）

## 输出格式
返回完整的配置 JSON
```

### 5.2 AI 调用

**配置文件**：`config/ai.json`

```json
{
  "provider": "openai",
  "model": "gpt-4",
  "temperature": 0.2,
  "maxTokens": 3000
}
```

**调用流程**：
```
1. 构建 Prompt
2. 调用 AI API
3. 解析 AI 响应
4. 校验配置
5. 返回推断结果
```

---

## 六、模板开发

### 6.1 Handlebars 模板（page.vue.hbs）

**模板语法**：

```handlebars
<template>
  <h-page-container>
    <h-page-search>
      {{#each searchArea}}
      <h-page-search-item label="{{label}}" prop="{{prop}}">
        <{{component}} v-model="filters.{{prop}}" {{propsString}} />
      </h-page-search-item>
      {{/each}}
    </h-page-search>
  </h-page-container>
</template>

<script>
export default {
  data() {
    return {
      filters: {
        {{#each searchArea}}
        {{prop}}: {{defaultValue}}{{#unless @last}},{{/unless}}
        {{/each}}
      }
    }
  }
}
</script>
```

**自定义 Helper**：

```javascript
// 注册 Handlebars Helper
Handlebars.registerHelper('kebabCase', str => {
  return str.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase()
})

Handlebars.registerHelper('pascalCase', str => {
  return str.charAt(0).toUpperCase() + str.slice(1)
})

Handlebars.registerHelper('eq', (a, b) => a === b)
```

### 6.2 模板开发规范

1. **结构固定**：模板定义固定的页面结构
2. **Slot 明确**：明确标注可填充的 Slot 位置
3. **数据驱动**：所有动态内容通过数据传入
4. **辅助函数**：使用 Helper 处理数据转换

---

## 七、组件开发

### 7.1 业务组件注册

**步骤**：

1. 开发 Vue 组件
2. 在 `componentLibrary.js` 中注册
3. 定义组件元数据
4. AI 即可识别使用

**注册示例**：

```javascript
{
  name: 'area-selector',
  label: '区域选择器',
  category: 'business',
  description: '双面板区域选择，支持层级浏览',
  wrapper: 'h-page-search-item',
  defaultProps: {
    searchable: true,
    multiple: true,
    hierarchical: true
  },
  props: [
    {
      name: 'searchable',
      label: '可搜索',
      type: 'boolean',
      default: true
    }
  ],
  apiRequirements: {
    loadOptions: {
      description: '加载区域列表',
      example: '/api/areas'
    }
  },
  suitableFor: ['searchArea', 'filterArea']
}
```

### 7.2 组件开发规范

1. **标准化属性**：使用标准的 prop 命名
2. **API 定义**：明确组件需要的 API
3. **事件规范**：使用标准的事件命名
4. **文档完善**：提供使用示例和说明

---

## 八、AI 推断逻辑

### 8.1 推断组件属性

**输入**：
- 组件类型：`el-input`
- API 字段：`userName`（string）

**推断逻辑**：
```
1. 根据字段名推断 label：userName → "用户名"
2. 根据字段类型推断 placeholder："请输入用户名"
3. 根据组件类型设置默认属性：clearable = true
```

**输出**：
```json
{
  "prop": "userName",
  "label": "用户名",
  "placeholder": "请输入用户名",
  "clearable": true
}
```

### 8.2 推断 API 配置

**输入**：
- API URL：`/api/users/list`
- API 文档（可选）

**推断逻辑**：
```
1. 分析 API 响应格式
2. 推断数据路径：data.rows, data.list 等
3. 推断总数路径：data.total, data.count 等
4. 推断分页参数：pageNo/pageSize 或 current/size
```

**输出**：
```json
{
  "dataPath": "data.rows",
  "totalPath": "data.total",
  "pageNoField": "pageNo",
  "pageSizeField": "pageSize"
}
```

### 8.3 推断组件依赖

**输入**：
- 组件列表：[区域选择器, 团队选择器]
- API 配置

**推断逻辑**：
```
1. 识别组件类型和语义
2. 推断依赖关系：区域 → 团队
3. 推断触发条件：区域变化时
4. 推断行为：清空团队、重新加载
```

**输出**：
```json
{
  "from": "selectedAreas",
  "to": "selectedTeams",
  "trigger": "change",
  "actions": ["clear", "reload"]
}
```

---

## 九、代码生成流程

### 9.1 完整流程

```
Step 1: 收集用户输入
  - 模板 ID
  - 组件列表
  - API 信息

Step 2: AI 推断配置
  - 调用 AI 推断组件属性
  - 调用 AI 推断 API 配置
  - 调用 AI 推断组件依赖

Step 3: 构建完整配置
  - 合并用户输入和 AI 推断结果
  - 校验配置（JSON Schema）
  - 生成配置 JSON

Step 4: Handlebars 模板渲染
  - 读取模板文件（page.vue.hbs）
  - 编译模板
  - 传入配置数据
  - 生成 template 部分

Step 5: AI 生成业务逻辑
  - 生成 API 调用代码
  - 生成数据流转代码
  - 生成事件处理代码
  - 生成 script 部分

Step 6: 合并和输出
  - 合并 template + script + style
  - 代码格式化
  - 代码校验
  - 返回最终代码
```

### 9.2 代码生成示例

**输入配置**：
```json
{
  "templateId": "standard-list",
  "slots": {
    "searchArea": [
      { "component": "el-input" },
      { "component": "el-select" }
    ]
  },
  "api": {
    "url": "/api/users/list",
    "method": "POST"
  }
}
```

**AI 推断**：
```json
{
  "searchArea": [
    {
      "component": "el-input",
      "props": {
        "prop": "userName",
        "label": "用户名"
      }
    },
    {
      "component": "el-select",
      "props": {
        "prop": "status",
        "label": "状态",
        "options": [...]
      }
    }
  ],
  "apiConfig": {
    "dataPath": "data.rows",
    "totalPath": "data.total"
  }
}
```

**生成代码**：
```vue
<template>
  <h-page-container>
    <h-page-search :model="filters">
      <h-page-search-item label="用户名" prop="userName">
        <el-input v-model="filters.userName" placeholder="请输入用户名" clearable />
      </h-page-search-item>
      <h-page-search-item label="状态" prop="status">
        <el-select v-model="filters.status" placeholder="请选择状态">
          <el-option label="启用" value="1" />
          <el-option label="禁用" value="0" />
        </el-select>
      </h-page-search-item>
    </h-page-search>
  </h-page-container>
</template>

<script>
export default {
  name: 'UserList',
  data() {
    return {
      filters: {
        userName: '',
        status: ''
      },
      list: [],
      pagination: {
        pageNo: 1,
        pageSize: 20,
        total: 0
      }
    }
  },
  methods: {
    async fetchData() {
      const params = {
        ...this.filters,
        pageNo: this.pagination.pageNo,
        pageSize: this.pagination.pageSize
      }
      const { data } = await this.$http.post('/api/users/list', params)
      this.list = data.rows || []
      this.pagination.total = data.total || 0
    }
  }
}
</script>
```

---

## 十、开发指南

### 10.1 环境搭建

```bash
# 克隆项目
git clone <repository-url>
cd ai-code

# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 运行测试
npm test
```

### 10.2 添加新模板

**步骤**：

1. 在 `templates/` 目录创建新文件夹
2. 创建 `template.json`（模板定义）
3. 创建 `page.vue.hbs`（Handlebars 模板）
4. 创建 `README.md`（模板说明）

**template.json 示例**：

```json
{
  "id": "my-template",
  "label": "我的模板",
  "description": "模板描述",
  "version": "1.0.0",
  "layout": {
    "structure": "fixed",
    "template": "page.vue.hbs"
  },
  "slots": {
    "searchArea": {
      "label": "搜索区",
      "maxCount": 6,
      "allowedComponents": ["el-input", "el-select"]
    }
  }
}
```

### 10.3 添加新组件

**步骤**：

1. 开发 Vue 组件
2. 在 `componentLibrary.js` 中注册
3. 定义组件元数据

**组件注册示例**：

```javascript
{
  name: 'my-component',
  label: '我的组件',
  category: 'business',
  defaultProps: {
    // 默认属性
  },
  props: [
    // 属性定义
  ],
  suitableFor: ['searchArea']
}
```

---

## 十一、测试

### 11.1 测试策略

1. **模板测试**：验证模板生成的代码
2. **组件测试**：验证组件库的元数据
3. **配置测试**：验证配置校验
4. **生成测试**：验证代码生成结果

### 11.2 测试命令

```bash
# 运行所有测试
npm test

# 运行特定测试
npm test -- codeGenerator

# 验证模板
npm run validate:templates

# 验证组件
npm run validate:components
```

---

## 十二、部署

### 12.1 构建

```bash
# 生产构建
npm run build

# 预览构建结果
npm run preview
```

### 12.2 配置

**AI 配置**（`config/ai.json`）：

```json
{
  "provider": "openai",
  "baseUrl": "https://api.openai.com/v1",
  "model": "gpt-4",
  "apiKey": "your-api-key"
}
```

---

## 十三、开发规范

### 13.1 代码规范

- ESLint：使用项目配置
- Prettier：自动格式化
- Git Hooks：提交前检查

### 13.2 提交规范

```
feat: 新功能
fix: 修复
docs: 文档
style: 格式
refactor: 重构
test: 测试
chore: 构建/工具
```

### 13.3 分支规范

- `main`：主分支（稳定）
- `develop`：开发分支
- `feature/*`：功能分支
- `fix/*`：修复分支

---

## 十四、常见问题

### Q1：如何调试 AI 推断？

**A**：查看 AI Prompt 和响应
```javascript
const prompt = await buildAIPrompt(config)
console.log('AI Prompt:', prompt)

const result = await generateWithAI(prompt, config)
console.log('AI Response:', result)
```

### Q2：如何自定义 Handlebars Helper？

**A**：在 `codeGenerator.js` 中注册
```javascript
Handlebars.registerHelper('myHelper', function(value) {
  return value.toUpperCase()
})
```

### Q3：如何添加新的组件类型？

**A**：在 `componentLibrary.js` 中添加定义
```javascript
{
  name: 'new-component',
  label: '新组件',
  // ...
}
```

---

## 十五、技术栈

### 15.1 前端技术

- **框架**：Vue 3 + Vite
- **UI 库**：Element Plus
- **状态管理**：Pinia
- **模板引擎**：Handlebars

### 15.2 开发工具

- **代码检查**：ESLint + Prettier
- **测试框架**：Vitest
- **构建工具**：Vite
- **版本控制**：Git + Husky

---

## 十六、总结

本工具采用"模板 + 组件库 + AI 推断"的架构，通过极简交互和智能推断，快速生成高质量的 Vue2 业务页面代码。

**核心技术**：
- Handlebars 模板引擎（保证代码稳定性）
- 组件库系统（支持业务组件扩展）
- AI 智能推断（自动推断配置和生成逻辑）

**开发要点**：
- 模板驱动：代码由模板生成
- 组件库驱动：组件可复用和扩展
- AI 辅助：推断配置和生成逻辑
- 配置校验：保证配置正确性

