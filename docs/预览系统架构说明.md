# é¢„è§ˆç³»ç»Ÿæ¶æ„è¯´æ˜

## ğŸ“ æ¶æ„è®¾è®¡

### æ ¸å¿ƒæ€æƒ³

**é¢„è§ˆç³»ç»Ÿæ ¹æ®æ¨¡æ¿é…ç½®åŠ¨æ€æ¸²æŸ“å¸ƒå±€ï¼Œä¸å†ç¡¬ç¼–ç å›ºå®šç»“æ„ã€‚**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€‰æ‹©æ¨¡æ¿       â”‚ â”€â”€â”€> â”‚  åŠ è½½ template   â”‚ â”€â”€â”€> â”‚  åŠ¨æ€æ¸²æŸ“å¸ƒå±€   â”‚
â”‚  (Editor)       â”‚      â”‚  .previewLayout  â”‚      â”‚  (iframe)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â†“
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  é€’å½’æ¸²æŸ“ç»„ä»¶æ ‘  â”‚
                         â”‚  - h-page-*      â”‚
                         â”‚  - drop zones    â”‚
                         â”‚  - slot æ’å…¥ç‚¹   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. **æ¨¡æ¿é…ç½® (template.json)**

æ¯ä¸ªæ¨¡æ¿éƒ½å®šä¹‰ `previewLayout`ï¼Œæè¿°é¢„è§ˆæ—¶çš„å¸ƒå±€ç»“æ„ï¼š

```json
{
  "previewLayout": {
    "description": "é¢„è§ˆæ—¶çš„åŠ¨æ€å¸ƒå±€é…ç½®",
    "root": {
      "component": "h-page-container",
      "class": "h-page-container",
      "children": [
        {
          "component": "h-page-header",
          "props": {
            "title": "{{pageInfo.title}}",
            "breadcrumb": "{{pageInfo.breadcrumb}}"
          }
        },
        {
          "component": "div",
          "class": "drop-zone h-page-search",
          "dropZone": "search",
          "slots": {
            "default": "searchArea"
          },
          "emptyText": "æ‹–æ‹½æœç´¢ç»„ä»¶åˆ°è¿™é‡Œ"
        }
      ]
    }
  }
}
```

**å…³é”®å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `component` | String | è¦æ¸²æŸ“çš„ç»„ä»¶å (å¦‚ `div`, `h-page-container`) |
| `class` | String | CSS ç±»å |
| `props` | Object | ç»„ä»¶çš„ propsï¼Œæ”¯æŒ `{{å˜é‡}}` æ’å€¼ |
| `dropZone` | String | æ‹–æ‹½åŒºåŸŸæ ‡è¯†ï¼ˆå¦‚ `search`, `table`ï¼‰ |
| `slots` | Object | slot æ˜ å°„ï¼Œkey ä¸º slot åï¼Œvalue ä¸º `components` ä¸­çš„åŒºåŸŸå |
| `emptyText` | String | ç©ºçŠ¶æ€æç¤ºæ–‡æœ¬ |
| `children` | Array | å­èŠ‚ç‚¹æ•°ç»„ï¼ˆé€’å½’ï¼‰ |

---

### 2. **é¢„è§ˆ iframe (preview-iframe.html)**

#### æ ¸å¿ƒç»„ä»¶ï¼š`layout-node`

é€’å½’ç»„ä»¶ï¼Œè´Ÿè´£æ¸²æŸ“å¸ƒå±€æ ‘ï¼š

```vue
<layout-node
  :node="templateLayout.root"
  :config="config"
  :drag-over-zone="dragOverZone"
  :selected-component-id="selectedComponentId"
  @dragover="handleDragOver"
  @drop="handleDrop"
  @select-component="handleSelectComponent"
/>
```

**åŠŸèƒ½ï¼š**
- âœ… **é€’å½’æ¸²æŸ“**ï¼šæ”¯æŒä»»æ„æ·±åº¦çš„åµŒå¥—ç»“æ„
- âœ… **åŠ¨æ€ç»„ä»¶**ï¼šæ ¹æ®é…ç½®åŠ¨æ€åˆ›å»ºç»„ä»¶
- âœ… **æ¨¡æ¿å˜é‡**ï¼šæ”¯æŒ `{{pageInfo.title}}` ç­‰æ’å€¼
- âœ… **Slot æ˜ å°„**ï¼šå°†ç”¨æˆ·æ‹–æ‹½çš„ç»„ä»¶æ’å…¥åˆ°æŒ‡å®šä½ç½®
- âœ… **Drop Zone**ï¼šè‡ªåŠ¨è¯†åˆ«æ‹–æ‹½åŒºåŸŸå¹¶å¤„ç†äº‹ä»¶

---

### 3. **PreviewPanel.vue**

è´Ÿè´£å‘ iframe å‘é€é…ç½®ï¼š

```javascript
const config = {
  pageInfo: editorStore.pageConfig.pageInfo,
  components: editorStore.pageConfig.components,
  templateLayout: editorStore.selectedTemplate?.previewLayout || null, // ğŸ‘ˆ æ¨¡æ¿å¸ƒå±€
  template: { ... }
}

previewIframe.value.contentWindow.postMessage({
  type: 'update-preview',
  config
}, '*')
```

---

## ğŸ¯ å·¥ä½œæµç¨‹

### ç”¨æˆ·æ“ä½œæµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Editor
    participant PreviewPanel
    participant Iframe
    participant LayoutNode

    User->>Editor: é€‰æ‹©æ¨¡æ¿
    Editor->>PreviewPanel: ä¼ é€’ selectedTemplate
    PreviewPanel->>Iframe: postMessage(templateLayout)
    Iframe->>LayoutNode: é€’å½’æ¸²æŸ“å¸ƒå±€æ ‘
    LayoutNode-->>Iframe: ç”Ÿæˆ DOM ç»“æ„
    
    User->>Editor: æ‹–æ‹½ç»„ä»¶
    Editor->>Iframe: postMessage(components)
    Iframe->>LayoutNode: æ›´æ–° slot å†…å®¹
    LayoutNode-->>Iframe: æ’å…¥ç»„ä»¶åˆ°æŒ‡å®šä½ç½®
```

### åˆ‡æ¢æ¨¡æ¿æµç¨‹

```
1. ç”¨æˆ·é€‰æ‹©æ–°æ¨¡æ¿
   â†“
2. Editor æ›´æ–° selectedTemplate
   â†“
3. PreviewPanel è¯»å– template.previewLayout
   â†“
4. é€šè¿‡ postMessage å‘é€åˆ° iframe
   â†“
5. iframe æ¥æ”¶åæ›´æ–° templateLayout
   â†“
6. layout-node é‡æ–°é€’å½’æ¸²æŸ“
   â†“
7. âœ¨ å¸ƒå±€å®Œå…¨åˆ‡æ¢ï¼
```

---

## ğŸš€ ä¼˜åŠ¿

### âœ… çœŸæ­£çš„æ¨¡æ¿ç³»ç»Ÿ
- ä¸åŒæ¨¡æ¿æœ‰ä¸åŒçš„å¸ƒå±€ç»“æ„
- åˆ‡æ¢æ¨¡æ¿å®æ—¶ç”Ÿæ•ˆ
- æ¨¡æ¿é…ç½®å¯æ‰©å±•

### âœ… çµæ´»æ€§
- æ”¯æŒä»»æ„åµŒå¥—å±‚çº§
- æ”¯æŒè‡ªå®šä¹‰ç»„ä»¶
- æ”¯æŒåŠ¨æ€æ’å€¼

### âœ… å¯ç»´æŠ¤æ€§
- å¸ƒå±€é…ç½®ä¸æ¸²æŸ“é€»è¾‘åˆ†ç¦»
- é€’å½’ç»„ä»¶ä»£ç ç®€æ´
- æ˜“äºæ·»åŠ æ–°æ¨¡æ¿

---

## ğŸ“ æ·»åŠ æ–°æ¨¡æ¿

### Step 1: åˆ›å»ºæ¨¡æ¿ç›®å½•

```bash
templates/my-new-template/
  â”œâ”€â”€ template.json       # æ¨¡æ¿é…ç½®
  â”œâ”€â”€ page.vue.hbs       # ä»£ç ç”Ÿæˆæ¨¡æ¿
  â””â”€â”€ README.md          # è¯´æ˜æ–‡æ¡£
```

### Step 2: å®šä¹‰ previewLayout

åœ¨ `template.json` ä¸­æ·»åŠ ï¼š

```json
{
  "id": "my-new-template",
  "label": "æˆ‘çš„æ–°æ¨¡æ¿",
  "previewLayout": {
    "root": {
      "component": "div",
      "class": "my-custom-layout",
      "children": [
        {
          "component": "div",
          "class": "drop-zone custom-zone",
          "dropZone": "customArea",
          "slots": {
            "default": "customComponents"
          },
          "emptyText": "æ‹–æ‹½ç»„ä»¶åˆ°è¿™é‡Œ"
        }
      ]
    }
  }
}
```

### Step 3: åœ¨ editorStore ä¸­æ³¨å†Œ

æ¨¡æ¿ä¼šè‡ªåŠ¨ä» `templates/` ç›®å½•åŠ è½½ã€‚

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹æ¨¡æ¿é…ç½®

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼š

```javascript
// æŸ¥çœ‹å½“å‰æ¨¡æ¿å¸ƒå±€
console.log('Template Layout:', app.templateLayout)

// æŸ¥çœ‹ç»„ä»¶é…ç½®
console.log('Components:', app.config.components)
```

### æ£€æŸ¥æ¸²æŸ“æ ‘

åœ¨ `layout-node` ç»„ä»¶ä¸­æ·»åŠ ï¼š

```javascript
created() {
  console.log('Rendering node:', this.node)
}
```

---

## ğŸ¨ ç¤ºä¾‹ï¼šæ ‡å‡†åˆ—è¡¨é¡µ

```
h-page-container
â”œâ”€â”€ h-page-header (æ˜¾ç¤ºæ ‡é¢˜å’Œé¢åŒ…å±‘)
â””â”€â”€ h-page-content
    â”œâ”€â”€ div.drop-zone (æœç´¢åŒº)
    â”‚   â””â”€â”€ slot: searchArea
    â”‚       â”œâ”€â”€ el-input (ç”¨æˆ·æ‹–æ‹½)
    â”‚       â”œâ”€â”€ el-select (ç”¨æˆ·æ‹–æ‹½)
    â”‚       â””â”€â”€ el-button (æŸ¥è¯¢/é‡ç½®)
    â””â”€â”€ div.drop-zone (è¡¨æ ¼åŒº)
        â”œâ”€â”€ slot: actionArea (æŒ‰é’®)
        â”œâ”€â”€ el-table (å›ºå®š)
        â””â”€â”€ el-pagination (å›ºå®š)
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¨¡æ¿å˜é‡æ ¼å¼**ï¼šä½¿ç”¨ `{{pageInfo.title}}`ï¼Œä¸æ˜¯ `${}`
2. **Slot å‘½å**ï¼šå¿…é¡»ä¸ `components` ä¸­çš„ key ä¸€è‡´
3. **Drop Zone**ï¼š`dropZone` å­—æ®µå¿…é¡»å”¯ä¸€
4. **é€’å½’æ·±åº¦**ï¼šå»ºè®®ä¸è¶…è¿‡ 10 å±‚

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `templates/standard-list/template.json` | æ ‡å‡†åˆ—è¡¨é¡µæ¨¡æ¿é…ç½® |
| `public/preview-iframe.html` | é¢„è§ˆ iframe å®ç° |
| `src/components/PreviewPanel.vue` | é¢„è§ˆé¢æ¿ç»„ä»¶ |
| `src/stores/editorStore.js` | ç¼–è¾‘å™¨çŠ¶æ€ç®¡ç† |

---

## ğŸ“– æ€»ç»“

é€šè¿‡ `previewLayout` é…ç½®å’Œ `layout-node` é€’å½’ç»„ä»¶ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

âœ… **çœŸæ­£çš„æ¨¡æ¿ç³»ç»Ÿ** - ä¸åŒæ¨¡æ¿æœ‰ä¸åŒçš„å¸ƒå±€  
âœ… **åŠ¨æ€æ¸²æŸ“** - æ ¹æ®é…ç½®ç”Ÿæˆ DOM  
âœ… **å¯æ‰©å±•æ€§** - æ˜“äºæ·»åŠ æ–°æ¨¡æ¿  
âœ… **ç”¨æˆ·å‹å¥½** - åˆ‡æ¢æ¨¡æ¿å®æ—¶ç”Ÿæ•ˆ  

**ä¸å†æ˜¯ç¡¬ç¼–ç çš„å›ºå®šå¸ƒå±€ï¼** ğŸ‰

