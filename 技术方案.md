## 技术方案 · 简版低代码本地出码工具（JSON → Vue2 SFC）

### 1. 技术栈与运行形态

- 应用框架：Vue3 + Vite（纯 JavaScript，不使用 TypeScript）
- 样式：TailwindCSS 或 UnoCSS（二选一，避免并用）
- 预览沙箱：独立 iframe 内运行 Vue2 + 指定组件库（hui），通过 CDN/UMD 注入
- AI 集成：HTTP API（可切换模型供应商），AI 仅生成/修正页面配置 JSON，不直接出码

### 2. 总体架构

```
用户操作 → 选择典型页面模板（布局固定） → 选择接口/粘贴文档 →（可选）上传截图
   │
   ├─ AI 推断器（仅推断数据映射）
   │     └─ 生成 页面配置 JSON（columns/dataMapping/searchFields/pagination/options）
   │
   ├─ 确认面板（数据映射微调）
   │     └─ 列配置、数据路径、分页映射、搜索字段、下拉选项
   │
   ├─ 出码器（模板渲染 + 数据注入）→ Vue2 SFC + 可选 service/router 片段
   │
   ├─ 自检：Schema 校验 / 语法校验 / ESLint / iframe 干跑（mock）
   │
   └─ 通过 → 一键复制代码 + 生成报告
```

**关键点**：

- 典型模板包含完整布局结构（组件、slot、层级），由团队预先设计
- AI 不推断布局，只推断数据相关内容（表格列、数据路径、分页映射等）
- 用户选择模板而非手动配置 slot 与占位

### 3. 目录结构（建议）

```
ai-code/
  templates/
    standard-list/
      template.json            # 模板清单（完整布局定义、AI 推断任务、dataflows）
      page.vue.hbs             # 完整页面模板（非片段拼接）
      preview.png              # 模板预览图（必须）
    left-tree-right-table/
      template.json
      page.vue.hbs
      preview.png
    form-basic/
      template.json
      page.vue.hbs
      preview.png

  manifests/
    hui-components.json        # hui 组件库元数据（从 hui/*.md 提取）

  app/                         # 工具前端（Vue3 + Vite + Tailwind/Uno）
    ...

  docs/
    产品文档.md
    技术方案.md

  config/
    ai.example.json            # AI 调用示例配置（可复制为 ai.json）
    providers.schema.json      # 供应商配置 Schema（可选）
```

### 4. 组件清单 Manifest（基于 hui 组件库）

用于约束 AI 与出码器：只能使用清单内组件与 props/事件。

```json
{
  "library": "@hui/vue@2.x",
  "source": "hui/*.md",
  "components": [
    {
      "name": "h-paged-table",
      "category": "list",
      "description": "集成表格与分页的组件",
      "requiredProps": ["fetch或url", "data", "total"],
      "commonProps": { 
        "pageSize": 10,
        "pageSizes": [10, 20, 30, 40, 50],
        "layout": "total, sizes, prev, pager, next, jumper"
      },
      "events": ["size-change", "current-change", "fetch-success", "fetch-error"],
      "vModel": null,
      "slots": { "default": "el-table with slot-scope" },
      "特殊说明": "data/total/pageCount 为函数式映射，如 :data='(json) => json.data.items'"
    },
    {
      "name": "h-page-container",
      "category": "layout",
      "requiredProps": [],
      "events": ["on-scroll"],
      "slots": { "pageHeader": "页面头部插槽", "default": "主内容区" }
    },
    {
      "name": "h-page-search",
      "category": "layout",
      "description": "搜索栏容器",
      "requiredProps": [],
      "slots": { "default": "通常放置 el-form" }
    },
    {
      "name": "el-form",
      "category": "form",
      "requiredProps": ["model"],
      "commonProps": { "inline": true, "label-width": "90px" },
      "events": ["submit"],
      "vModel": null
    },
    {
      "name": "el-input",
      "category": "input",
      "requiredProps": [],
      "events": ["input", "change"],
      "vModel": { "prop": "value", "event": "input" }
    }
  ]
}
```

**元数据来源**：从 `hui/*.md` 文档提取（### Attributes、### Events、### Slot 章节）

### 5. 模板清单 Template Manifest（JSON）

典型页面模板定义**完整布局结构**，用户无需手动配置 slot 与占位。

```json
{
  "id": "standard-list",
  "label": "标准列表页",
  "description": "带搜索的表格列表，适用于数据查询、管理场景",
  "preview": "templates/standard-list/preview.png",
  "version": "1.0.0",
  
  "layout": {
    "structure": "fixed",
    "template": "page.vue.hbs",
    "components": {
      "root": "h-page-container",
      "search": "h-page-search + el-form",
      "table": "h-page-content > h-paged-table > el-table"
    }
  },
  
  "aiTasks": [
    "推断表格列（字段名、类型、显示标签、宽度）",
    "推断数据路径映射（dataPath、totalPath）",
    "推断分页参数映射（page、pageSize）",
    "推断搜索字段（基于请求参数）",
    "推断枚举字段的选项来源"
  ],
  
  "dataflows": {
    "hPagedTable": {
      "dataPath": ["data.results", "data.items", "items", "result.list"],
      "totalPath": ["data.totalRecord", "data.total", "total", "totalCount"],
      "pageCountPath": ["data.totalPage", "data.pageCount", "pageCount"]
    },
    "pagination": {
      "pageParam": ["page", "current", "pageNum"],
      "pageSizeParam": ["pageSize", "size", "pageCount"]
    },
    "dictHints": { 
      "label": ["title", "label", "name"], 
      "value": ["value", "id", "code"] 
    }
  },
  
  "componentDefaults": {
    "h-paged-table": {
      "pageSize": 10,
      "pageSizes": [10, 20, 30, 40, 50],
      "layout": "total, sizes, prev, pager, next, jumper"
    },
    "el-table": {
      "stripe": true,
      "force-scroll": true
    },
    "el-form": {
      "inline": true
    }
  }
}
```

**关键点**：

- `structure: "fixed"` 表示布局固定，AI 不推断组件选择与层级
- `aiTasks` 明确 AI 的推断范围（仅数据相关）
- `dataflows` 定义数据路径的识别优先级

### 6. 页面配置 JSON（由 AI 生成/修正）

AI 仅生成数据映射相关配置，不包含布局信息。

```json
{
  "templateId": "standard-list",
  "pageName": "CustomerList",
  "breadcrumb": ["客户管理", "客户列表"],
  
  "api": {
    "url": "/api/customers",
    "method": "GET",
    "params": {
      "page": "page",
      "pageSize": "pageSize"
    },
    "sampleResponse": {
      "data": {
        "items": [
          {"id": 1, "name": "张三", "phone": "13800138000", "status": "active", "createdAt": "2024-01-01 10:00:00"}
        ],
        "total": 120
      }
    }
  },
  
  "dataMapping": {
    "dataPath": "json.data.items",
    "totalPath": "json.data.total",
    "confidence": 0.95
  },
  
  "searchFields": [
    { 
      "prop": "name", 
      "label": "客户名称", 
      "type": "input",
      "confidence": 0.9
    },
    { 
      "prop": "status", 
      "label": "状态", 
      "type": "select",
      "options": [
        {"label": "启用", "value": "active"},
        {"label": "停用", "value": "disabled"}
      ],
      "confidence": 0.85
    }
  ],
  
  "columns": [
    { "prop": "id", "label": "ID", "width": "80", "type": "text" },
    { "prop": "name", "label": "客户名称", "type": "text" },
    { "prop": "phone", "label": "联系电话", "type": "text" },
    { 
      "prop": "status", 
      "label": "状态", 
      "type": "tag",
      "mapping": {
        "active": {"label": "启用", "type": "success"},
        "disabled": {"label": "停用", "type": "info"}
      }
    },
    { "prop": "createdAt", "label": "创建时间", "type": "datetime" }
  ]
}
```

**说明**：

- `confidence` 字段标识 AI 推断的置信度（0-1），低于 0.8 需在确认面板标注
- `dataMapping` 定义 `h-paged-table` 所需的函数式映射路径
- `searchFields` 和 `columns` 完全由 AI 根据 API 样例推断

### 7. 出码器（JSON → Vue2 SFC）

- 模板引擎：Handlebars/EJS，渲染完整的 `page.vue.hbs`（非片段拼接）
- 步骤：
  1) **校验**：

     - 页面配置 JSON Schema 校验
     - 组件白名单检查（必须来自 hui-components.json）
     - 必填字段完整性检查（dataMapping、columns 等）
  2) **渲染**：

     - 加载模板文件 `templates/{templateId}/page.vue.hbs`
     - 注入上下文：
       - 页面元数据（pageName、breadcrumb）
       - API 配置（url、method、params）
       - 数据映射表达式（dataPath、totalPath 转为函数式映射）
       - 列配置（columns）
       - 搜索字段配置（searchFields）
       - 组件默认 props（从模板清单）
     - 生成完整 Vue2 SFC（template + script + style）
  3) **自检**：

     - 语法校验：vue-template-compiler、eslint-plugin-vue@2
     - 干跑测试：iframe 内加载 Vue2 + hui 组件库，注入 mock 数据
       - 断言：表格渲染≥1行
       - 断言：分页切换正常
       - 断言：搜索字段有正确的组件与选项
  4) **输出**：

     - Vue2 SFC 代码
     - 可选 service.js（封装请求方法）
     - 可选 router 配置片段
     - 生成报告（数据映射清单、依赖版本、注意事项）
  5) **通过** → 一键复制代码 + 下载报告

### 8. API 选择器与解析

- **输入方式**（MVP 版本）：

  - 粘贴真实响应样例 JSON（最简单直接）
  - 粘贴请求参数 JSON（可选，用于识别分页和搜索字段）
  
  > **说明**：MVP 版本专注于粘贴方式，暂时不包含 OpenAPI 文档解析和对内部文档平台的对接功能，后续版本可根据需要扩展。
- **解析要点**：

  - **数据路径识别**：按模板的 `dataflows.hPagedTable.dataPath` 优先级递归查找数组类型字段
  - **总数路径识别**：按 `dataflows.hPagedTable.totalPath` 优先级查找数字类型字段
  - **分页参数识别**：从请求参数中识别分页字段（按 `dataflows.pagination` 优先级）
  - **搜索参数提取**：非分页参数作为搜索字段候选
  - **枚举/字典识别**：
    - 字段名匹配：`*status*`、`*type*`、`*category*`
    - 值集合有限（≤20 个不同值）
    - 响应中包含字典数据（`dict/options/enums` 等键）
  - **label/value 映射**：按 `dictHints` 优先级推断
- **适配 h-paged-table**：

  - 生成函数式映射表达式：`(json) => json.data.items`
  - 支持嵌套路径：`(json) => json.result.list`

### 9. 预览与隔离

- 主应用：Vue3 工具界面
- 预览：iframe 中加载 Vue2 + 指定组件库（全局注册），将生成的 SFC 注入并挂载
- 通信：postMessage 传递 mock 数据、渲染结果与错误日志，避免 Vue2/3 冲突

### 10. 校验与错误处理

- Schema 校验：ajv（模板、页面配置、组件清单）
- 语法/风格：vue-template-compiler、eslint-plugin-vue@2、Prettier
- 运行干跑：mock 首屏拉取 + 一次分页切换
- 失败回路：收集错误（缺字段、props 不兼容、语法错误、运行异常）→ 显示在确认面板 → 允许一键“让 AI 修正 JSON”或手动点选

### 11. 输出规范

- 必须使用指定组件库（按全局注册或按需导入策略之一）
- 生成内容：
  - Vue2 SFC：template/script/style（Options API）
  - 可选 `service.js`：封装请求与分页参数
  - 可选 `router.js` 片段
- 生成报告：列映射、分页映射、下拉映射、默认值/校验、库版本要求

### 12. MVP 里程碑

- **M1（P0）**：

  - 3 个典型页面模板（标准列表页、基础表单页、详情查看页）
  - hui 组件元数据提取与 `hui-components.json` 生成
  - API 选择器（粘贴样例响应优先）
  - AI 推断器（仅数据映射：columns、dataPath、pagination、searchFields）
  - 确认面板（数据映射微调、置信度标注）
  - 出码器（基于模板渲染完整 SFC）+ 三重校验（Schema/语法/干跑）
  - iframe 预览（Vue2 + hui 组件库）
- **M2（P1）**：

  - 2 个扩展模板（左树右表页、多 Tab 列表页）
  - 字典联动（远程 options 接口）
  - 枚举字段的 Tag 映射自动推断
  - 历史记录与版本对比
  - 生成报告增强（映射清单、依赖版本、注意事项）
- **M3（P2）**：

  - 模板自定义与导入（支持团队自定义模板 ZIP）
  - 图片辅助推断（列顺序、宽度、显隐）
  - 多接口组合（主列表 + 远程字典）
  - 代码优化建议（性能检查）
  - 生成 `service.js` 与 `router` 配置片段

### 13. hui 组件库集成与元数据管理

#### 13.1 组件库说明

- **依赖库**：所有生成代码依赖 `@hui/` 组件库（独立组件库，非 Element UI）
- **版本策略**：当前所有项目使用统一的 hui 版本，生成代码时在注释中声明依赖版本
- **文档位置**：`hui/*.md`（Markdown 格式，包含组件 API、示例代码）

#### 13.2 元数据提取策略

**目标**：从 `hui/*.md` 文档中提取组件元数据，生成 `manifests/hui-components.json`

**提取方法（半自动化）**：

1. **解析 Markdown**：

   - 识别 `### Attributes` 表格 → 提取 props（参数名、类型、默认值、说明）
   - 识别 `### Events` 表格 → 提取 events（事件名、回调参数）
   - 识别 `### Slot` 表格 → 提取 slots（名称、说明）
   - 识别 `### Methods` 表格 → 提取 methods（方法名、参数）
2. **特殊处理**：

   - `h-paged-table`：标注函数式映射特性（`:data="(json) => ..."`)
   - `h-page-container`：标注具名 slot 使用方式
   - 嵌套组件关系：如 `h-paged-table` 内部需要 `el-table`
3. **人工校验**：

   - 处理不规范的文档格式
   - 补充关键组件的使用约束
   - 添加常见用法示例

**提取工具**：

- 正则表达式 + Markdown 解析器（如 `marked`、`remark`）
- 表格识别（| 分隔的 Markdown 表格）
- 输出为标准 JSON Schema

#### 13.3 关键组件特性

**h-paged-table（核心组件）**：

- 集成了表格与分页功能
- 使用函数式响应映射：
  ```vue
  <h-paged-table
    :fetch="fetchTableData"
    :data="(json) => json.data.items"
    :total="(json) => json.data.total"
  >
    <el-table slot-scope="props" :data="props.data" force-scroll>
      <!-- columns -->
    </el-table>
  </h-paged-table>
  ```
- AI 推断任务：
  - 从 API 响应识别数据路径（`json.data.items` vs `json.items`）
  - 从 API 响应识别总数路径（`json.data.total` vs `json.total`）
  - 生成正确的函数式映射表达式

**h-page-* 布局组件**：

- `h-page-container`：页面最外层容器，支持 `pageHeader` 具名 slot
- `h-page-header`：页面头部（面包屑、返回按钮）
- `h-page-content`：主内容区域
- `h-page-search`：搜索栏容器

**使用约束**：

- 必须按层级关系使用（`h-page-container` > `h-page-content` > `h-paged-table`）
- `h-paged-table` 内部必须包含 `el-table`（使用 `slot-scope`）
- `el-table` 必须设置 `force-scroll` 属性

#### 13.4 组件清单维护流程

1. **初始化**（M1 阶段）：

   - 手动提取 10-15 个核心组件元数据
   - 建立 `hui-components.json` 基础版本
   - 验证出码器与校验器正常工作
2. **迭代扩展**（M2/M3）：

   - 开发半自动化提取工具
   - 批量提取剩余组件元数据
   - 建立 hui 文档变更监控机制
3. **版本同步**：

   - hui 组件库升级时，同步更新元数据
   - 检查 Breaking Changes，更新模板与出码器
   - 提供迁移指南（如有必要）

#### 13.5 出码器适配

**模板渲染注意事项**：

- `h-paged-table` 的 `data`/`total` props 渲染为函数式映射
- 确保 `el-table` 包含 `slot-scope="props"` 和 `:data="props.data"`
- 自动添加 `force-scroll` 属性到 `el-table`
- 生成 `fetch` 方法时正确处理分页参数

**示例代码片段**（Handlebars）：

```handlebars
<h-paged-table
  ref="pagedTable"
  :fetch="fetchTableData"
  :data="(json) => {{dataPath}}"
  :total="(json) => {{totalPath}}"
  @fetch-success="handleFetchSuccess"
  @fetch-error="handleFetchError"
>
  <el-table
    slot-scope="props"
    :data="props.data"
    force-scroll
    stripe
  >
    {{#each columns}}
    <el-table-column
      prop="{{this.prop}}"
      label="{{this.label}}"
      {{#if this.width}}width="{{this.width}}"{{/if}}
    ></el-table-column>
    {{/each}}
  </el-table>
</h-paged-table>
```

### 14. 决策记录（关键约束）

- **布局由模板定义**：典型页面模板包含完整布局结构，用户只选不改
- **AI 仅推断数据映射**：AI 不推断布局、组件选择与层级关系，只推断表格列、数据路径、分页映射等数据相关内容
- **依赖 hui 组件库**：生成代码严格使用 `@hui/` 组件库，不使用 Element UI
- **AI 不直接出码**：AI 仅生成/修正页面配置 JSON，出码器基于模板渲染
- **组件信息来自 Manifest**：不从主应用 window 读取组件，组件信息来自静态 `hui-components.json`
- **预览隔离**：预览与干跑必须在 iframe（Vue2 运行时）完成，避免与主应用（Vue3）冲突
- **样式方案唯一**：仅支持一个样式方案（Tailwind 或 Uno），避免并用

### 15. AI 沟通与模型调用

#### 15.1 目标与边界

- **目标**：引导 AI 生成/修正"页面配置 JSON"中的**数据映射部分**，并对低置信度项进行交互式确认
- **边界**：
  - AI **不推断布局**（布局由用户选择的模板定义）
  - AI **不直接产出代码**，仅生成结构化 JSON（符合页面配置 Schema）
  - AI **仅推断数据相关内容**：表格列、数据路径、分页映射、搜索字段、枚举选项
  - AI 不执行任意脚本，输出必须在受控 Schema 与组件 Manifest 范围内

#### 14.2 调用策略与供应商抽象

- 统一适配层：抽象 `ProviderAdapter` 接口（sendPrompt → structured result），屏蔽不同厂商 API 差异。
- 支持多供应商与模型切换：OpenAI、Claude、通义千问、讯飞星火等；优先走官方或企业专线 Endpoint。
- 关键可配项：
  - 基础：baseUrl、apiKey/AK/SK、model、requestTimeout、retryPolicy（指数退避、最大重试次数）
  - 生成参数：temperature、top_p、max_tokens、response_format（JSON 优先）
  - 合规：敏感词过滤、可选数据脱敏开关（字段名/值掩码）

建议以 `config/ai.json` 配置（本地，仅开发环境），生产通过环境变量注入：

```
{
  "defaultProvider": "openai",
  "providers": [
    {
      "name": "openai",
      "baseUrl": "https://api.openai.com/v1",
      "model": "gpt-4o-mini",
      "requestTimeoutMs": 20000,
      "retry": { "maxAttempts": 2, "baseDelayMs": 500 },
      "generation": { "temperature": 0.1, "top_p": 1, "max_tokens": 3000 }
    }
  ]
}
```

#### 15.3 Prompt 工程与上下文构造

- **上下文组成**：

  - **模板信息**（已选模板）：
    - 模板 ID、名称、描述
    - `aiTasks` 列表（明确 AI 需要推断什么）
    - `dataflows` 配置（数据路径识别优先级、分页参数映射规则、字典 hints）
  - **API 信息**：
    - 请求方法、URL、参数（区分分页参数与搜索参数）
    - 响应样例（完整 JSON 或结构化 Schema）
  - **hui 组件特性**（摘要）：
    - `h-paged-table` 的函数式映射要求
    - 常见列类型（text、datetime、tag 等）
  - **用户偏好**（可选）：
    - 字段显示顺序、隐藏字段
    - 特定字段的类型覆盖
- **角色设定**：

  - 系统 Prompt 明确：
    - "你是数据映射专家，不负责布局设计"
    - "仅输出页面配置 JSON 中的数据映射部分"
    - "遵循 Schema，不输出布局相关字段"
    - "低置信度时标注 confidence < 0.8"
- **关键 Prompt 模板**：

  1. **生成初稿**：

  ```
  你需要为 hui 组件库的"{templateLabel}"模板生成数据映射配置。

  模板已定义完整布局，你只需推断以下内容：
  {aiTasks列表}

  API 信息：
  - 请求：{method} {url}，参数：{params}
  - 响应样例：{sampleResponse}

  数据路径识别优先级：{dataflows.hPagedTable.dataPath}
  分页参数优先级：{dataflows.pagination}

  请输出 JSON 格式的页面配置（仅包含 dataMapping、searchFields、columns），
  每个推断项带上 confidence（0-1）。
  ```

  2. **修正回路**：

  ```
  以下页面配置在校验/干跑时失败：
  - 错误：{errorMessages}
  - 当前配置：{currentConfig}

  请修正配置中的错误，保持已确认项不变。
  ```

  3. **局部推断**：

  ```
  请为字段 "{fieldName}" 推断合适的列类型（text/datetime/tag/link）。
  字段值示例：{sampleValues}
  ```
- **输出约束**：

  - 强制 `response_format=json` 或添加 JSON 包裹指令
  - 超出 Schema 的字段自动忽略
  - 解析失败时触发一次"仅返回 JSON"纠偏

#### 15.4 交互与多轮流程

1) **生成初稿**：

   - 用户选择模板 + 提供 API 信息
   - 构造 Prompt（包含模板的 aiTasks、dataflows、API 样例）
   - 调用 AI 模型
   - 解析为页面配置 JSON（仅数据映射部分）
2) **自检与置信度标注**：

   - Schema 校验（必填字段、类型检查）
   - 数据路径验证（在样例响应中能否找到对应路径）
   - 标注低置信度项（confidence < 0.8）
3) **确认面板**：

   - 展示 AI 推断结果（表格列、数据路径、搜索字段、枚举选项）
   - 高亮低置信度项，提供候选选项
   - 用户微调（修改列标题、调整顺序、选择数据路径、配置枚举映射）
   - 形成"最小差异指令"（用户仅修改必要的部分）
4) **修正回路**（如需要）：

   - 干跑测试失败（如数据路径错误、枚举映射缺失）
   - 将错误信息 + 当前配置 + 约束作为输入
   - 调用 AI 返回修正版 JSON（保留已确认项）
   - 最多重试 2 次，失败则要求用户手动修正
5) **通过后导出**：

   - 基于模板渲染完整 Vue2 SFC
   - 生成报告（数据映射清单、依赖版本、注意事项）
   - 一键复制代码 + 下载报告

#### 14.5 错误处理与降级

- 网络/速率：指数退避重试；必要时切换备用模型；对用户展示可重试入口。
- 响应异常：解析失败或非 JSON → 触发一次“仅返回 JSON”纠偏；仍失败则回落到本地启发式推断（规则与样例驱动）。
- 质量门槛：置信度低于阈值（如 0.8）时必须进入确认面板；严禁直接导出。

#### 14.6 成本与隐私

- 成本控制：
  - 压缩上下文（Manifest 精简、字段抽样）
  - 缓存相同 API 样例的推断结果
  - 分步调用：先推断映射，再生成整体，减少冗余 token
- 隐私合规：
  - 默认脱敏 API/样例中的用户标识/敏感字段（如手机号/身份号）
  - 明确数据出境与存储策略；支持本地/企业私有化模型接入

#### 15.7 MVP 要求补充

- **M1（P0）**：

  - 单一主流模型接入（如 OpenAI GPT-4 或 Claude 3.5 Sonnet）
  - 生成 + 修正 两类 Prompt 流程跑通
  - JSON 强约束（`response_format=json`）与校验回路
  - 置信度标注与确认面板集成
  - 失败回路（最多 2 次重试）
- **M2（P1）**：

  - 多供应商可切换（OpenAI、Claude、通义千问等）
  - 优雅降级（AI 失败时回退到规则推断）
  - Prompt 模板分场景管理（生成、修正、局部推断）
  - 成本统计（token 消耗、调用次数）
- **M3（P2）**：

  - Prompt A/B 测试与优化
  - 成本报告与预警
  - 数据脱敏策略面板化配置
  - 本地模型接入支持（私有化部署）
